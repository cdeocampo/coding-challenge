---
AWSTemplateFormatVersion: "2010-09-09"

Description:
  This CloudFormation script will create the web-tier

Parameters:
  SSHKeyNameParam:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Amazon EC2 Key Pair
  VpcIdParam:
    Type: AWS::EC2::VPC::Id
    Description: VPC Id where to put the servers
  PublicSubnetsParam:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Public subnets for application load balancer
  PrivateSubnetsParam:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Private subnets for web server
  InitialWebServerCapacityParam:
    Type: Number
    MinValue: 1
    MaxValue: 5
    Description: Initial number of instances acting as web server

Mappings:
  Ami:
    ap-southeast-1:
      ContainerInstance: ami-f88ade84

Resources:
  AppLBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VpcIdParam
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: TRIBE Application LB SG

  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Only allow IPs or SGs that only need to access the web servers
      VpcId: !Ref VpcIdParam
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 8080
        ToPort: 8080
        SourceSecurityGroupId: !Ref AppLBSecurityGroup
      Tags:
      - Key: Name
        Value: TRIBE Web Server SG

  EcsForEc2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2008-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: ecs.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role

  EcsForEc2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
      - !Ref WebServerRole

  WebServerLaunchConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !FindInMap [Ami, !Ref "AWS::Region", ContainerInstance]
      IamInstanceProfile: !Ref EcsForEc2InstanceProfile
      InstanceType: t2.micro
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      KeyName: !Ref SSHKeyNameParam
      UserData:
        Fn::Base64: !Sub |
          #cloud-config
          package_update: false
          runcmd:
            - /opt/aws/bin/cfn-signal -e 0 --stack ${AWS::StackName} --resource WebServerLaunchConfig --region ${AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Count: !Ref InitialWebServerCapacityParam
        Timeout: PT10M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
        MaxBatchSize: 1
        MinSuccessfulInstancesPercent: 50
        PauseTime: PT15M
        WaitOnResourceSignals: true
        SuspendProcesses:
        - HealthCheck
        - ReplaceUnhealthy
        - AZRebalance
        - AlarmNotification
        - ScheduledActions

  WebTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 60
      UnhealthyThresholdCount: 10
      HealthCheckPath: /
      Port: 8080
      Protocol: HTTP
      VpcId: !Ref VpcIdParam

  WebServerAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      LaunchConfigurationName: !Ref WebServerLaunchConfig
      TargetGroupARNs:
        - !Ref WebTargetGroup
      MinSize: 1
      MaxSize: 4
      DesiredCapacity: !Ref InitialWebServerCapacityParam
      VPCZoneIdentifier: !Ref PrivateSubnetsParam
      Tags:
      - Key: Name
        Value: TRIBE Web Server
        PropagateAtLaunch: true

  WebServerAutoScalingPolicyAddInstance:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerAutoScalingGroup
      Cooldown: 120 # 2 minutes
      ScalingAdjustment: 1

  WebServerAutoScalingPolicyRemoveInstance:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref WebServerAutoScalingGroup
      Cooldown: 120 # 2 minutes
      ScalingAdjustment: -1

  WebServerCPUAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Alarm if CPU if cpu averages > 80 for 60 seconds
      MetricName: CPUUtilization
      AlarmActions:
      -  !Ref WebServerAutoScalingPolicyAddInstance
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref WebServerAutoScalingGroup
      Namespace: AWS/EC2
      EvaluationPeriods: 1
      Period: 60 # 1 minute
      Statistic: Average
      Threshold: 80

  WebServerCPUAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Alarm if CPU if cpu averages < 30 for 3 minutes
      MetricName: CPUUtilization
      AlarmActions:
      -  !Ref WebServerAutoScalingPolicyRemoveInstance
      ComparisonOperator: LessThanThreshold
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref WebServerAutoScalingGroup
      Namespace: AWS/EC2
      EvaluationPeriods: 3
      Period: 60 # 1 minute
      Statistic: Average
      Threshold: 30

  AppLB8080Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref WebTargetGroup
      LoadBalancerArn: !Ref AppLB
      Port: 8080
      Protocol: HTTP

  AppLB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: tribe-app-lb
      Scheme: internet-facing
      SecurityGroups:
        - !Ref AppLBSecurityGroup
      Subnets: !Ref PublicSubnetsParam
      Type: application

  EcsServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2008-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: ecs.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceRole

  EcsCluster:
    Type: AWS::ECS::Cluster

  WebTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
        - Name: WebServer
          Image: hello-world
          Cpu: 10
          Memory: 128
          PortMappings:
            - ContainerPort: 8080
              HostPort: 8080
          EntryPoint:
            - /usr/sbin/apache2
            - -D
            - FOREGROUND
          Essential: true
      Family: webserver

  WebApp:
    Type: AWS::ECS::Service
    DependsOn:
    - AppLB8080Listener
    Properties:
      Role: !Ref EcsServiceRole
      TaskDefinition: !Ref WebTaskDefinition
      DesiredCount: 1
      LoadBalancers:
      - TargetGroupArn: !Ref WebTargetGroup
        ContainerPort: 8080
        ContainerName: WebServer
      Cluster: !Ref EcsCluster

Outputs:
  ApplicationDnsName:
    Description: DNS name for the load balanced application
    Value: !GetAtt AppLB.DNSName